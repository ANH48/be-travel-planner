// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String              @id @default(uuid())
  email         String              @unique
  password      String
  name          String
  avatar        String?
  role          UserRole            @default(USER)
  fcmToken      String?             @map("fcm_token")
  emailVerified Boolean             @default(false) @map("email_verified")
  verifiedAt    DateTime?           @map("verified_at")
  trips         Trip[]
  invitations   MemberInvitation[]  @relation("InvitedUser")
  sentInvites   MemberInvitation[]  @relation("Inviter")
  notifications Notification[]
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  @@map("users")
}

model Trip {
  id          String             @id @default(uuid())
  ownerId     String             @map("owner_id")
  owner       User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name        String
  description String?
  location    String
  startDate   DateTime           @map("start_date")
  endDate     DateTime           @map("end_date")
  status      TripStatus         @default(UPCOMING)
  members     TripMember[]
  expenses    Expense[]
  settlements Settlement[]
  itineraries ItineraryItem[]
  invitations MemberInvitation[]
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  @@index([ownerId])
  @@map("trips")
}

model TripMember {
  id                String         @id @default(uuid())
  tripId            String         @map("trip_id")
  trip              Trip           @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId            String?        @map("user_id") // null if guest member
  name              String
  email             String?
  phone             String?
  isPaid            Boolean        @default(false) @map("is_paid")
  paidExpenses      Expense[]      @relation("Payer")
  createdExpenses   Expense[]      @relation("ExpenseCreator")
  expenseSplits     ExpenseSplit[]
  createdItinerary  ItineraryItem[] @relation("ItineraryCreator")
  settlements       Settlement[]
  createdAt         DateTime       @default(now()) @map("created_at")

  @@index([tripId])
  @@map("trip_members")
}

model Expense {
  id           String          @id @default(uuid())
  tripId       String          @map("trip_id")
  trip         Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  payerId      String          @map("payer_id")
  payer        TripMember      @relation("Payer", fields: [payerId], references: [id])
  createdById  String?         @map("created_by_id")
  createdBy    TripMember?     @relation("ExpenseCreator", fields: [createdById], references: [id])
  category     ExpenseCategory
  amount       Decimal         @db.Decimal(12, 2)
  description  String
  expenseDate  DateTime        @map("expense_date")
  receiptImage String?         @map("receipt_image")
  splitType    SplitType       @default(EQUAL) @map("split_type")
  splits       ExpenseSplit[]
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  @@index([tripId])
  @@index([payerId])
  @@index([createdById])
  @@map("expenses")
}

model ExpenseSplit {
  id         String     @id @default(uuid())
  expenseId  String     @map("expense_id")
  expense    Expense    @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  memberId   String     @map("member_id")
  member     TripMember @relation(fields: [memberId], references: [id])
  amount     Decimal    @db.Decimal(12, 2)
  percentage Decimal?   @db.Decimal(5, 2) // 0-100
  createdAt  DateTime   @default(now()) @map("created_at")

  @@index([expenseId])
  @@index([memberId])
  @@map("expense_splits")
}

model Settlement {
  id        String     @id @default(uuid())
  tripId    String     @map("trip_id")
  trip      Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)
  memberId  String     @map("member_id")
  member    TripMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  amount    Decimal    @db.Decimal(12, 2) // Tổng số tiền member này cần trả
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@unique([tripId, memberId])
  @@index([tripId])
  @@index([memberId])
  @@map("settlements")
}

model ItineraryItem {
  id          String      @id @default(uuid())
  tripId      String      @map("trip_id")
  trip        Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdById String?     @map("created_by_id")
  createdBy   TripMember? @relation("ItineraryCreator", fields: [createdById], references: [id])
  date        DateTime
  startTime   String      @map("start_time") // Format: "HH:mm"
  endTime     String?     @map("end_time")   // Format: "HH:mm"
  activity    String
  location    String?
  category    String?
  description String?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([tripId])
  @@index([date])
  @@index([createdById])
  @@map("itinerary_items")
}

enum TripStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

enum ExpenseCategory {
  FOOD
  TRANSPORT
  ACCOMMODATION
  ENTERTAINMENT
  OTHER
}

enum SplitType {
  EQUAL
  EXACT
  PERCENTAGE
}

enum UserRole {
  USER
  ADMIN
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum NotificationType {
  TRIP_INVITATION
  EXPENSE_ADDED
  ITINERARY_ADDED
  MEMBER_JOINED
  INVITATION_CANCELLED
}

model MemberInvitation {
  id         String           @id @default(uuid())
  tripId     String           @map("trip_id")
  trip       Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)
  inviterId  String           @map("inviter_id")
  inviter    User             @relation("Inviter", fields: [inviterId], references: [id])
  invitedEmail String         @map("invited_email")
  invitedUser  User?          @relation("InvitedUser", fields: [invitedUserId], references: [id])
  invitedUserId String?       @map("invited_user_id")
  status     InvitationStatus @default(PENDING)
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt @map("updated_at")

  @@unique([tripId, invitedEmail])
  @@index([invitedEmail])
  @@index([invitedUserId])
  @@index([tripId])
  @@map("member_invitations")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json?            // Extra data like tripId, invitationId, etc.
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  code      String   // 6-digit OTP
  expiresAt DateTime @map("expires_at")
  verified  Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@index([code])
  @@map("email_verifications")
}
